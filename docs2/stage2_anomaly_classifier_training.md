# ç¬¬äºŒé˜¶æ®µè¯¦ç»†æŒ‡å—ï¼šå¼‚å¸¸åˆ†ç±»å™¨è®­ç»ƒ

## ğŸ“‹ æ¦‚è¿°

ç¬¬äºŒé˜¶æ®µä¸“æ³¨äºè®­ç»ƒåŸºäºè¯¾ç¨‹å­¦ä¹ çš„å¼‚å¸¸åˆ†ç±»å™¨ï¼Œç”¨äºæ£€æµ‹å­¦ä¹ è¡Œä¸ºåºåˆ—ä¸­çš„å¼‚å¸¸æ¨¡å¼ã€‚è¯¥é˜¶æ®µæ˜¯å¼‚å¸¸æ„ŸçŸ¥çŸ¥è¯†è¿½è¸ªç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ã€‚

## ğŸ¯ è®­ç»ƒç›®æ ‡

1. **å¼‚å¸¸æ£€æµ‹èƒ½åŠ›**: å‡†ç¡®è¯†åˆ«å­¦ä¹ åºåˆ—ä¸­çš„å¼‚å¸¸è¡Œä¸º
2. **è¯¾ç¨‹å­¦ä¹ **: ä»ç®€å•åˆ°å¤æ‚çš„æ¸è¿›å¼è®­ç»ƒ
3. **å› æœæ€§ä¿è¯**: ä¸¥æ ¼éµå®ˆæ—¶åºå› æœå…³ç³»
4. **æ³›åŒ–èƒ½åŠ›**: åœ¨ä¸åŒç±»å‹å¼‚å¸¸ä¸Šçš„é²æ£’æ€§èƒ½

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶

#### 1. å› æœå¼‚å¸¸æ£€æµ‹å™¨ (`CausalAnomalyDetector`)
- **åŸºäºTransformer**: åˆ©ç”¨è‡ªæ³¨æ„åŠ›æœºåˆ¶æ•è·åºåˆ—ä¾èµ–
- **å› æœæ©ç **: ç¡®ä¿åªä½¿ç”¨å†å²ä¿¡æ¯è¿›è¡Œé¢„æµ‹
- **ç»Ÿè®¡ç‰¹å¾**: ç»“åˆçª—å£ç»Ÿè®¡ç‰¹å¾å¢å¼ºæ£€æµ‹èƒ½åŠ›
- **å¤šå±‚æ¶æ„**: å¯é…ç½®çš„Transformerå±‚æ•°

#### 2. è¯¾ç¨‹å­¦ä¹ ç³»ç»Ÿ
- **4çº§éš¾åº¦ä½“ç³»**: ä»ç®€å•åˆ°æéš¾çš„å¼‚å¸¸åˆ†ç±»
- **æ¸è¿›å¼è°ƒåº¦**: åŠ¨æ€è°ƒæ•´è®­ç»ƒéš¾åº¦
- **è‡ªé€‚åº”æƒé‡**: æ ¹æ®æ¨¡å‹æ€§èƒ½è°ƒæ•´éš¾åº¦åˆ†å¸ƒ

#### 3. å¼‚å¸¸ç”Ÿæˆå™¨
- **åŸºçº¿ç”Ÿæˆå™¨**: ç”¨äºæŠ€æœ¯éªŒè¯çš„ç®€å•å¼‚å¸¸
- **è¯¾ç¨‹ç”Ÿæˆå™¨**: æ•™è‚²ä»·å€¼é«˜çš„å¤æ‚å¼‚å¸¸æ¨¡å¼

## ğŸ“Š è¯¾ç¨‹å­¦ä¹ ä½“ç³»

### éš¾åº¦çº§åˆ«è®¾è®¡

| çº§åˆ« | åç§° | å¼‚å¸¸ç‰¹å¾ | æ£€æµ‹éš¾åº¦ | æ•™è‚²ä»·å€¼ | ç¤ºä¾‹ç­–ç•¥ |
|------|------|----------|----------|----------|----------|
| **Level 1** | ç®€å•å¼‚å¸¸ | æ˜æ˜¾å¯æ£€æµ‹ | ä½ | ä¸­ | è¿ç»­é”™è¯¯ã€ç®€å•éšæœº |
| **Level 2** | ä¸­ç­‰å¼‚å¸¸ | éœ€è¦æ¨¡å¼è¯†åˆ« | ä¸­ | é«˜ | å‘¨æœŸæ€§å¼‚å¸¸ã€çªå‘é”™è¯¯ |
| **Level 3** | å›°éš¾å¼‚å¸¸ | å¾®å¦™æ—¶åºå¼‚å¸¸ | é«˜ | é«˜ | èƒ½åŠ›ä¸åŒ¹é…ã€æ¸è¿›å˜åŒ– |
| **Level 4** | æéš¾å¼‚å¸¸ | é«˜çº§æ¬ºéª—æ€§ | æé«˜ | æé«˜ | æ™ºèƒ½æ©è”½ã€æ¬ºéª—æ¨¡å¼ |

### è®­ç»ƒé˜¶æ®µ

```mermaid
graph LR
    A[é¢„çƒ­é˜¶æ®µ] --> B[æ—©æœŸé˜¶æ®µ]
    B --> C[ä¸­æœŸé˜¶æ®µ]
    C --> D[é«˜çº§é˜¶æ®µ]
    
    A --> A1[Level 1: 100%]
    B --> B1[Level 1: 70%<br/>Level 2: 30%]
    C --> C1[Level 1: 30%<br/>Level 2: 50%<br/>Level 3: 20%]
    D --> D1[Level 1: 10%<br/>Level 2: 30%<br/>Level 3: 40%<br/>Level 4: 20%]
```

## âš™ï¸ é…ç½®å‚æ•°è¯¦è§£

### åŸºæœ¬å‚æ•°

```yaml
# æ•°æ®é›†å’Œè®¾å¤‡é…ç½®
dataset: assist17              # æ•°æ®é›†åç§°
device: cuda                   # è®­ç»ƒè®¾å¤‡
baseline_model_path: "..."     # ç¬¬ä¸€é˜¶æ®µæ¨¡å‹è·¯å¾„
```

### å¼‚å¸¸æ£€æµ‹å™¨å‚æ•°

```yaml
# æ¨¡å‹æ¶æ„ï¼ˆè‡ªåŠ¨ä»åŸºçº¿æ¨¡å‹ç»§æ‰¿ï¼‰
d_model: 256                   # æ¨¡å‹ç»´åº¦
n_heads: 16                    # æ³¨æ„åŠ›å¤´æ•°
n_layers: 2                    # æ£€æµ‹å™¨å±‚æ•°ï¼ˆæ¯”åŸºçº¿å°‘ï¼‰
dropout: 0.1                   # Dropoutç‡
window_size: 10                # ç»Ÿè®¡ç‰¹å¾çª—å£
```

### è¯¾ç¨‹å­¦ä¹ å‚æ•°

```yaml
# è®­ç»ƒé…ç½®
anomaly_epochs: 50             # è®­ç»ƒè½®æ•°
learning_rate: 0.001           # å­¦ä¹ ç‡
patience: 10                   # æ—©åœè€å¿ƒå€¼

# è¯¾ç¨‹è°ƒåº¦
curriculum_type: linear        # è°ƒåº¦ç±»å‹
initial_difficulty: 0.1        # åˆå§‹éš¾åº¦
final_difficulty: 0.8          # æœ€ç»ˆéš¾åº¦
warmup_epochs: 5               # é¢„çƒ­è½®æ•°
```

## ğŸš€ ä½¿ç”¨æŒ‡å—

### åŸºç¡€ä½¿ç”¨

#### 1. åŸºç¡€æ¨¡å‹çš„å¼‚å¸¸åˆ†ç±»å™¨

```bash
python scripts/run_stage2_anomaly_classifier.py \
    --dataset assist17 \
    --model_type basic \
    --baseline_model_path output/stage1_basic_assist17_*/baseline/best_model.pt \
    --auto_config \
    --device cuda
```

#### 2. æ‰©å±•æ¨¡å‹çš„å¼‚å¸¸åˆ†ç±»å™¨

```bash
python scripts/run_stage2_anomaly_classifier.py \
    --dataset assist17 \
    --model_type extended \
    --baseline_model_path output/stage1_extended_assist17_*/baseline/best_model.pt \
    --auto_config \
    --device cuda
```

### é«˜çº§é…ç½®

#### è‡ªå®šä¹‰è¯¾ç¨‹å­¦ä¹ 

```bash
python scripts/run_stage2_anomaly_classifier.py \
    --dataset assist17 \
    --model_type basic \
    --baseline_model_path "..." \
    --anomaly_epochs 100 \
    --curriculum_type exponential \
    --initial_difficulty 0.05 \
    --final_difficulty 0.9 \
    --warmup_epochs 10 \
    --device cuda
```

#### è°ƒè¯•æ¨¡å¼

```bash
python scripts/run_stage2_anomaly_classifier.py \
    --dataset assist17 \
    --model_type basic \
    --baseline_model_path "..." \
    --anomaly_epochs 5 \
    --batch_size 4 \
    --device cpu
```

## ğŸ“ˆ æ€§èƒ½è¯„ä¼°

### è¯„ä¼°æŒ‡æ ‡

1. **AUC (Area Under Curve)**: ä¸»è¦è¯„ä¼°æŒ‡æ ‡
2. **PR-AUC (Precision-Recall AUC)**: ä¸å¹³è¡¡æ•°æ®é›†çš„è¡¥å……æŒ‡æ ‡
3. **F1-Score**: ç²¾ç¡®ç‡å’Œå¬å›ç‡çš„è°ƒå’Œå¹³å‡
4. **åˆ†å±‚æ€§èƒ½**: ä¸åŒéš¾åº¦çº§åˆ«çš„æ£€æµ‹æ€§èƒ½

### è¯„ä¼°ç­–ç•¥

ç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨å¤šç§å¼‚å¸¸ç­–ç•¥ä¸Šè¯„ä¼°æ¨¡å‹ï¼š

- **éšæœºç¿»è½¬**: åŸºç¡€æ£€æµ‹èƒ½åŠ›éªŒè¯
- **å‡åŒ€éšæœº**: æœ€ç®€å•çš„å¼‚å¸¸æ¨¡å¼
- **ç³»ç»Ÿåå·®**: ä¸­ç­‰éš¾åº¦çš„æ¨¡å¼å¼‚å¸¸
- **é«˜æ–¯å™ªå£°**: å™ªå£°é²æ£’æ€§æµ‹è¯•

### é¢„æœŸæ€§èƒ½

| æ¨¡å‹ç±»å‹ | ç›®æ ‡AUC | éšæœºç¿»è½¬AUC | ç³»ç»Ÿåå·®AUC | è®­ç»ƒæ—¶é—´ |
|----------|---------|-------------|-------------|----------|
| **åŸºç¡€æ¨¡å‹** | 0.75-0.80 | 0.80+ | 0.70+ | 20-25åˆ†é’Ÿ |
| **æ‰©å±•æ¨¡å‹** | 0.80-0.85 | 0.85+ | 0.75+ | 30-40åˆ†é’Ÿ |

## ğŸ“ è¾“å‡ºç»“æ„

```
output/stage2_basic_assist17_20240101_120000/
â”œâ”€â”€ config.yaml                    # è®­ç»ƒé…ç½®
â”œâ”€â”€ anomaly_classifier/             # å¼‚å¸¸åˆ†ç±»å™¨ç›®å½•
â”‚   â”œâ”€â”€ best_anomaly_detector.pt   # æœ€ä½³æ¨¡å‹
â”‚   â”œâ”€â”€ training_log.txt           # è®­ç»ƒæ—¥å¿—
â”‚   â””â”€â”€ evaluation_report.txt      # è¯„ä¼°æŠ¥å‘Š
â””â”€â”€ plots/                         # å¯è§†åŒ–å›¾è¡¨
    â”œâ”€â”€ curriculum_progress.png    # è¯¾ç¨‹å­¦ä¹ è¿›åº¦
    â”œâ”€â”€ difficulty_distribution.png # éš¾åº¦åˆ†å¸ƒ
    â””â”€â”€ performance_curves.png     # æ€§èƒ½æ›²çº¿
```

## ğŸ”§ è°ƒä¼˜å»ºè®®

### æ€§èƒ½ä¼˜åŒ–

1. **æ¨¡å‹å®¹é‡è°ƒæ•´**
   ```bash
   # å¢åŠ æ£€æµ‹å™¨å±‚æ•°
   --n_layers 3
   
   # è°ƒæ•´çª—å£å¤§å°
   --window_size 15
   ```

2. **è¯¾ç¨‹å­¦ä¹ è°ƒä¼˜**
   ```bash
   # æ›´é•¿çš„é¢„çƒ­æœŸ
   --warmup_epochs 10
   
   # æ›´æ¿€è¿›çš„éš¾åº¦å¢é•¿
   --curriculum_type exponential
   ```

3. **è®­ç»ƒç­–ç•¥**
   ```bash
   # æ›´å¤šè®­ç»ƒè½®æ•°
   --anomaly_epochs 100
   
   # è°ƒæ•´å­¦ä¹ ç‡
   --learning_rate 0.0005
   ```

### å¸¸è§é—®é¢˜è§£å†³

#### 1. æ£€æµ‹æ€§èƒ½ä¸ä½³
- å¢åŠ æ¨¡å‹å®¹é‡ (`--n_layers`, `--window_size`)
- å»¶é•¿è®­ç»ƒæ—¶é—´ (`--anomaly_epochs`)
- è°ƒæ•´è¯¾ç¨‹å­¦ä¹ ç­–ç•¥

#### 2. è®­ç»ƒä¸ç¨³å®š
- é™ä½å­¦ä¹ ç‡ (`--learning_rate 0.0005`)
- å¢åŠ é¢„çƒ­è½®æ•° (`--warmup_epochs`)
- ä½¿ç”¨çº¿æ€§è°ƒåº¦ (`--curriculum_type linear`)

#### 3. å†…å­˜ä¸è¶³
- å‡å°‘æ‰¹æ¬¡å¤§å° (`--batch_size 8`)
- é™ä½æ¨¡å‹ç»´åº¦
- ä½¿ç”¨CPUè®­ç»ƒ

## ğŸ”¬ å®éªŒå»ºè®®

### æ¶ˆèç ”ç©¶

1. **è¯¾ç¨‹å­¦ä¹ æ•ˆæœ**
   ```bash
   # æœ‰è¯¾ç¨‹å­¦ä¹ 
   --curriculum_type linear
   
   # æ— è¯¾ç¨‹å­¦ä¹ ï¼ˆå›ºå®šéš¾åº¦ï¼‰
   --initial_difficulty 0.5 --final_difficulty 0.5
   ```

2. **éš¾åº¦çº§åˆ«å½±å“**
   ```bash
   # åªä½¿ç”¨ç®€å•å¼‚å¸¸
   --final_difficulty 0.3
   
   # åŒ…å«æ‰€æœ‰éš¾åº¦
   --final_difficulty 0.8
   ```

3. **æ¨¡å‹æ¶æ„å½±å“**
   ```bash
   # æµ…å±‚æ¨¡å‹
   --n_layers 1
   
   # æ·±å±‚æ¨¡å‹
   --n_layers 4
   ```

### å¯¹æ¯”å®éªŒ

å»ºè®®åŒæ—¶è®­ç»ƒåŸºç¡€æ¨¡å‹å’Œæ‰©å±•æ¨¡å‹çš„å¼‚å¸¸åˆ†ç±»å™¨ï¼Œè¿›è¡Œæ€§èƒ½å¯¹æ¯”ï¼š

```bash
# åŸºç¡€æ¨¡å‹å¼‚å¸¸åˆ†ç±»å™¨
python scripts/run_stage2_anomaly_classifier.py \
    --dataset assist17 --model_type basic \
    --baseline_model_path "åŸºç¡€æ¨¡å‹è·¯å¾„" \
    --auto_config --device cuda

# æ‰©å±•æ¨¡å‹å¼‚å¸¸åˆ†ç±»å™¨  
python scripts/run_stage2_anomaly_classifier.py \
    --dataset assist17 --model_type extended \
    --baseline_model_path "æ‰©å±•æ¨¡å‹è·¯å¾„" \
    --auto_config --device cuda
```

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### è®­ç»ƒç›‘æ§

è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šå®æ—¶æ˜¾ç¤ºï¼š
- å½“å‰è¯¾ç¨‹çŠ¶æ€ï¼ˆéš¾åº¦ã€é˜¶æ®µï¼‰
- è®­ç»ƒæŸå¤±å’ŒAUC
- éªŒè¯æ€§èƒ½
- æ—©åœçŠ¶æ€

### æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹è®­ç»ƒæ—¥å¿—
tail -f output/stage2_*/anomaly_classifier/training_log.txt

# æŸ¥çœ‹è¯„ä¼°æŠ¥å‘Š
cat output/stage2_*/anomaly_classifier/evaluation_report.txt
```

## ğŸ”„ ä¸å…¶ä»–é˜¶æ®µçš„è¡”æ¥

### è¾“å…¥ä¾èµ–
- **ç¬¬ä¸€é˜¶æ®µè¾“å‡º**: åŸºçº¿æ¨¡å‹æƒé‡å’Œé…ç½®
- **æ•°æ®é›†**: ä¸ç¬¬ä¸€é˜¶æ®µç›¸åŒçš„æ•°æ®é›†

### è¾“å‡ºäº§ç‰©
- **å¼‚å¸¸æ£€æµ‹å™¨**: ç”¨äºç¬¬ä¸‰é˜¶æ®µçš„å¼‚å¸¸æ„ŸçŸ¥çŸ¥è¯†è¿½è¸ª
- **è¯„ä¼°æŠ¥å‘Š**: å¼‚å¸¸æ£€æµ‹æ€§èƒ½åŸºå‡†
- **è®­ç»ƒé…ç½®**: å¯é‡ç°çš„å®éªŒè®¾ç½®

### ç¬¬ä¸‰é˜¶æ®µå‡†å¤‡

ç¬¬äºŒé˜¶æ®µå®Œæˆåï¼Œå¯ä»¥è¿›å…¥ç¬¬ä¸‰é˜¶æ®µï¼š

```bash
python scripts/run_stage3_anomaly_aware_kt.py \
    --dataset assist17 \
    --model_type basic \
    --baseline_model_path "ç¬¬ä¸€é˜¶æ®µæ¨¡å‹è·¯å¾„" \
    --anomaly_detector_path "ç¬¬äºŒé˜¶æ®µæ£€æµ‹å™¨è·¯å¾„" \
    --device cuda
```

è¿™ä¸ªç¬¬äºŒé˜¶æ®µä¸ºæ•´ä¸ªå¼‚å¸¸æ„ŸçŸ¥çŸ¥è¯†è¿½è¸ªç³»ç»Ÿæä¾›äº†æ ¸å¿ƒçš„å¼‚å¸¸æ£€æµ‹èƒ½åŠ›ï¼Œæ˜¯è¿æ¥åŸºçº¿è®­ç»ƒå’Œæœ€ç»ˆå¼‚å¸¸æ„ŸçŸ¥æ¨¡å‹çš„å…³é”®æ¡¥æ¢ã€‚
